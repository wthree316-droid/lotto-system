<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; }
        .admin-header { background: #212529; color: white; padding: 15px 0; }
        .table-card { border-radius: 10px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <nav class="admin-header mb-4 shadow-sm">
        <div class="container d-flex justify-content-between align-items-center">
            <h4 class="m-0"><i class="fas fa-user-shield"></i> ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h4>
            <a href="index.html" class="btn btn-outline-light btn-sm">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login</a>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3><i class="fas fa-users text-primary"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
            <button class="btn btn-primary" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            </button>
        </div>

        <div class="card table-card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover m-0 align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th class="ps-4">‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th>PIN</th>
                                <th>IP Address</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ IP</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            <tr><td colspan="6" class="text-center py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PIN = "9999"; 

        document.addEventListener('DOMContentLoaded', () => {
            const input = prompt("üîí Admin Access: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô");
            if (input !== ADMIN_PIN) {
                alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
                window.location.href = 'index.html'; 
            } else {
                loadData();
            }
        });

        async function loadData() {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-primary"><div class="spinner-border spinner-border-sm"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

            try {
                // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ IP ‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏ô‡πÅ‡∏ö‡∏ô‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
                const bannedSnap = await db.collection("banned_ips").get();
                const bannedIPs = new Set();
                bannedSnap.forEach(doc => bannedIPs.add(doc.id)); // ‡πÉ‡∏ä‡πâ IP ‡πÄ‡∏õ‡πá‡∏ô ID ‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£

                // 2. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ User
                const usersSnap = await db.collection("users").orderBy("created_at", "desc").get();

                if (usersSnap.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                    return;
                }

                let html = '';
                usersSnap.forEach((doc) => {
                    const user = doc.data();
                    const docId = doc.id;
                    const ip = user.ip_address || 'Unknown';
                    const isBanned = bannedIPs.has(ip); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ IP ‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏ô‡πÅ‡∏ö‡∏ô‡πÑ‡∏´‡∏°

                    let dateStr = user.created_at ? user.created_at.toDate().toLocaleString('th-TH') : "-";

                    // ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ô
                    let banBtn = '';
                    let statusBadge = '';

                    if (isBanned) {
                        statusBadge = `<span class="badge bg-danger">DOM BANNED</span>`;
                        banBtn = `<button class="btn btn-sm btn-outline-success mx-1" onclick="unbanIP('${ip}')" title="‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô"><i class="fas fa-unlock"></i> ‡∏õ‡∏•‡∏î</button>`;
                    } else {
                        statusBadge = `<span class="badge bg-success">‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
                        banBtn = `<button class="btn btn-sm btn-outline-dark mx-1" onclick="banIP('${ip}')" title="‡πÅ‡∏ö‡∏ô IP ‡∏ô‡∏µ‡πâ"><i class="fas fa-ban"></i> ‡πÅ‡∏ö‡∏ô</button>`;
                    }

                    html += `
                        <tr>
                            <td class="ps-4 fw-bold text-primary">${user.name}</td>
                            <td><span class="badge bg-secondary font-monospace">${user.pin}</span></td>
                            <td class="font-monospace">${ip}</td>
                            <td>${statusBadge}</td>
                            <td>${dateStr}</td>
                            <td class="text-center">
                                ${banBtn}
                                <button class="btn btn-sm btn-danger mx-1" onclick="deleteUser('${docId}', '${user.name}')"><i class="fas fa-trash"></i> ‡∏•‡∏ö</button>
                            </td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;

            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${error.message}</td></tr>`;
            }
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ö‡∏ô IP ---
        function banIP(ip) {
            if(ip === 'Unknown') { alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ö‡∏ô IP ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); return; }
            if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô IP: ${ip} ?\n‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ IP ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ`)) {
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å IP ‡∏•‡∏á collection 'banned_ips' ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ IP ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏•‡∏¢ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏á‡πà‡∏≤‡∏¢)
                db.collection("banned_ips").doc(ip).set({
                    banned_at: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert("‡πÅ‡∏ö‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                    loadData(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                });
            }
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô IP ---
        function unbanIP(ip) {
            if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô IP: ${ip} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                db.collection("banned_ips").doc(ip).delete().then(() => {
                    alert("‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                    loadData();
                });
            }
        }

        function deleteUser(docId, name) {
            if (confirm(`‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${name}" ?`)) {
                db.collection("users").doc(docId).delete().then(() => loadData());
            }
        }
    </script>
</body>
</html>
