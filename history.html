<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประวัติการบันทึก</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f8f9fa; padding-bottom: 80px; }
        .bill-header-info { font-size: 0.9rem; }
        .grand-total-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #212529;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

</head>
<body>
    <nav class="navbar navbar-dark bg-dark mb-4 shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#" id="back-link">
                <i class="fas fa-arrow-left"></i> <span id="back-text">ย้อนกลับ</span>
            </a>
            <span class="navbar-text text-white"><i class="fas fa-history"></i> ประวัติบิลย้อนหลัง</span>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="m-0"><i class="fas fa-list-alt text-primary"></i> รายการบิลทั้งหมด</h4>
            <button class="btn btn-outline-danger btn-sm" onclick="clearHistory()">
                <i class="fas fa-trash"></i> ล้างประวัติ
            </button>
        </div>

        <div class="accordion" id="historyAccordion">
            </div>
    </div>

    <div class="grand-total-bar d-flex justify-content-between align-items-center">
        <span class="fs-5">ยอดรวมส่งโพยทั้งหมด:</span>
        <span class="fs-3 fw-bold text-warning" id="grand-total-display">0 บาท</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. ฟังก์ชันจัดการปุ่มย้อนกลับ (Back Button Logic)
            handleBackButton();
            // 2. โหลดข้อมูลประวัติ
            loadHistory();
        });

        function handleBackButton() {
            // รับค่าจาก URL (เช่น ?from=menu หรือ ?from=lotto)
            const params = new URLSearchParams(window.location.search);
            const fromPage = params.get('from');
            
            const backLink = document.getElementById('back-link');
            const backText = document.getElementById('back-text');

            if (fromPage === 'menu') {
                // ถ้ามาจากหน้าเมนู
                backLink.href = 'menu.html';
                backText.innerText = 'กลับหน้าเมนู';
            } else {
                // ค่าเริ่มต้น หรือมาจากหน้าคีย์หวย
                backLink.href = 'lotto.html';
                backText.innerText = 'กลับหน้าคีย์';
            }
        }

        function loadHistory() {
        const container = document.getElementById('historyAccordion');
        const grandTotalDisplay = document.getElementById('grand-total-display');
        
        const currentUser = localStorage.getItem('agentName');
        if(!currentUser) {
            window.location.href = 'login.html'; // ถ้าไม่มีชื่อ ดีดกลับไปล็อกอิน
            return;
        }

        // อัปเดตหัวข้อ
        document.querySelector('h4').innerHTML = `<i class="fas fa-list-alt text-primary"></i> ประวัติบิลของ: <span class="text-dark">${currentUser}</span>`;
        
        container.innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-primary"></div><p>กำลังโหลดข้อมูลจาก Cloud...</p></div>';

        // --- ดึงข้อมูลจาก Firebase ---
        // เลือกคอลเลกชัน "bills"
        // เลือกเฉพาะบิลที่ "agent" เป็นชื่อเรา (User1)
        // เรียงตามเวลาล่าสุดขึ้นก่อน
        db.collection("bills")
            .where("agent", "==", currentUser)
            .orderBy("timestamp", "desc") 
            .get()
            .then((querySnapshot) => {
                
                container.innerHTML = ''; // ล้าง Loading
                let grandTotal = 0;

                if (querySnapshot.empty) {
                    container.innerHTML = '<div class="alert alert-secondary text-center py-5">ยังไม่มีข้อมูลประวัติ</div>';
                    grandTotalDisplay.innerText = "0 บาท";
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const bill = doc.data();
                    const billId = `bill-${doc.id}`; // ใช้ ID ของ Firebase
                    grandTotal += bill.total;

                    // ... (ส่วนสร้าง HTML ตาราง เหมือนโค้ดเดิมเป๊ะ แค่เปลี่ยนตัวแปรนิดหน่อย) ...
                    let itemRows = '';
                    bill.items.forEach(item => {
                        itemRows += `
                            <tr>
                                <td class="text-start ps-4">${item.number}</td>
                                <td><span class="badge bg-light text-dark border">${item.type}</span></td>
                                <td class="text-end pe-4 text-primary fw-bold">${item.price}</td>
                            </tr>
                        `;
                    });

                    const html = `
                        <div class="accordion-item mb-2 border shadow-sm">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${billId}">
                                    <div class="w-100 d-flex flex-column flex-md-row justify-content-between pe-3">
                                        <div>
                                            <div class="fw-bold text-dark"><i class="fas fa-user me-1"></i> ลูกค้า: ${bill.owner}</div>
                                            <div class="text-muted small">
                                                <span class="badge bg-info text-dark me-1">${bill.lottoName}</span>
                                                <i class="far fa-clock ms-1"></i> ${bill.dateString}
                                            </div>
                                        </div>
                                        <div class="text-md-end">
                                            <span class="fw-bold text-success fs-5">${bill.total.toLocaleString()} ฿</span>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="${billId}" class="accordion-collapse collapse" data-bs-parent="#historyAccordion">
                                <div class="accordion-body p-0">
                                    <table class="table table-striped table-hover mb-0 text-center align-middle">
                                        <thead class="table-light text-secondary small">
                                            <tr><th class="text-start ps-4">เลข</th><th>ประเภท</th><th class="text-end pe-4">ราคา</th></tr>
                                        </thead>
                                        <tbody>${itemRows}</tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });

                grandTotalDisplay.innerText = grandTotal.toLocaleString() + " บาท";
            })
            .catch((error) => {
                console.log("Error getting documents: ", error);
                container.innerHTML = '<div class="alert alert-danger">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>';
            });
    }

    // ฟังก์ชันลบประวัติ (เปลี่ยนเป็นลบใน Cloud)
    function clearHistory() {
        const currentUser = localStorage.getItem('agentName');
        if (confirm(`ยืนยันลบประวัติทั้งหมดของ ${currentUser} (กู้คืนไม่ได้)?`)) {
            // ต้องคิวรี่มาลบทีละตัว (Firestore ไม่มีคำสั่งลบทั้งก้อนทีเดียวจากหน้าเว็บเพื่อความปลอดภัย)
            db.collection("bills").where("agent", "==", currentUser).get()
            .then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    db.collection("bills").doc(doc.id).delete();
                });
                alert("ลบข้อมูลเรียบร้อย");
                loadHistory(); // โหลดใหม่
            });
        }
    }

        function clearHistory() {
            if (confirm('ยืนยันที่จะลบประวัติการบันทึก "ทั้งหมด" หรือไม่?')) {
                localStorage.removeItem('lottoHistory');
                loadHistory();
            }
        }
    </script>
</body>
</html>