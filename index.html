<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เข้าสู่ระบบ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        body {
            background-color: #212529;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Sarabun', sans-serif;
            flex-direction: column;
        }
        .login-card {
            background: white;
            padding: 2.5rem;
            border-radius: 15px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            z-index: 2;
        }
        .nav-pills .nav-link { color: #6c757d; background-color: #f8f9fa; margin: 0 5px; border-radius: 8px; transition: all 0.3s; cursor: pointer; }
        .nav-pills .nav-link.active { color: white; background-color: #0d6efd; font-weight: bold; box-shadow: 0 4px 6px rgba(13, 110, 253, 0.3); }
        .ip-footer { margin-top: 20px; color: #6c757d; font-size: 0.85rem; text-align: center; }
        
        /* หน้าจอสีแดงตอนโดนแบน */
        #banned-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #dc3545; color: white;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999;
        }
    </style>
</head>
<body>

    <div id="banned-screen" class="d-none">
        <i class="fas fa-ban fa-5x mb-4"></i>
        <h1 class="fw-bold">ACCESS DENIED</h1>
        <p class="fs-4">IP Address ของคุณถูกระงับการใช้งาน</p>
        <p class="small text-white-50">กรุณาติดต่อผู้ดูแลระบบ</p>
        <div class="mt-3 p-2 bg-dark rounded font-monospace" id="banned-ip-display"></div>
    </div>

    <div class="login-card" id="main-interface">
        <div class="text-center mb-4 text-primary">
            <i class="fas fa-shield-alt fa-4x"></i>
        </div>
        <h3 class="text-center fw-bold mb-4">TEAMZENT LOTTO</h3>

        <div id="state-loading" class="text-center py-4">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <p class="text-muted">กำลังตรวจสอบความปลอดภัย...</p>
        </div>

        <div id="state-login" class="d-none">
            <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
                <li class="nav-item"><button class="nav-link active" id="pills-login-tab" data-bs-toggle="pill" data-bs-target="#pills-login" type="button">เข้าสู่ระบบ</button></li>
                <li class="nav-item"><button class="nav-link" id="pills-register-tab" data-bs-toggle="pill" data-bs-target="#pills-register" type="button">ลงทะเบียนใหม่</button></li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-login">
                    <div class="mb-3"><label class="form-label text-secondary fw-bold">ชื่อผู้ใช้งาน</label><input type="text" class="form-control bg-light" id="loginName" placeholder="เช่น User1"></div>
                    <div class="mb-3"><label class="form-label text-secondary fw-bold">รหัส PIN (4 หลัก)</label><input type="password" class="form-control bg-light" id="loginPin" placeholder="****" maxlength="4"></div>
                    <button class="btn btn-primary w-100 py-2 shadow-sm" onclick="handleLogin()">เข้าใช้งาน <i class="fas fa-arrow-right ms-1"></i></button>
                </div>
                <div class="tab-pane fade" id="pills-register">
                    <div class="alert alert-info small border-0 py-2"><i class="fas fa-user-plus"></i> สร้างบัญชีใหม่</div>
                    <div class="mb-3"><label class="form-label text-secondary">ตั้งชื่อผู้ใช้งาน</label><input type="text" class="form-control" id="regName" placeholder="เช่น User1"></div>
                    <div class="row">
                        <div class="col-6 mb-3"><label class="form-label text-secondary">PIN (4 หลัก)</label><input type="password" class="form-control" id="regPin" placeholder="****" maxlength="4"></div>
                        <div class="col-6 mb-3"><label class="form-label text-secondary">ยืนยัน PIN</label><input type="password" class="form-control" id="regPinConfirm" placeholder="****" maxlength="4"></div>
                    </div>
                    <button class="btn btn-success w-100 py-2 shadow-sm" onclick="handleRegister()">ยืนยันการลงทะเบียน</button>
                </div>
            </div>
        </div>
    </div>

    <div class="ip-footer" id="footer-ip">
        <i class="fas fa-wifi me-1"></i> Your IP: <span id="user-ip" class="fw-bold">Checking...</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. เช็ค IP ก่อนทำอย่างอื่น
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => {
                    const myIP = data.ip;
                    document.getElementById('user-ip').innerText = myIP;
                    
                    // --- ตรวจสอบกับ Firebase Blacklist ---
                    checkBanStatus(myIP);
                })
                .catch(() => {
                    document.getElementById('user-ip').innerText = "Unknown";
                    // ถ้าเช็ค IP ไม่ได้ ให้เข้าใช้งานได้ไปก่อน (หรือจะบล็อกก็ได้แล้วแต่)
                    initSystem();
                });
        });

        function checkBanStatus(ip) {
            db.collection("banned_ips").doc(ip).get()
            .then((doc) => {
                if (doc.exists) {
                    // *** โดนแบน! ***
                    document.getElementById('banned-screen').classList.remove('d-none');
                    document.getElementById('banned-ip-display').innerText = "IP: " + ip;
                    document.getElementById('main-interface').remove(); // ลบกล่อง Login ทิ้ง
                    document.getElementById('footer-ip').remove();
                } else {
                    // *** ไม่โดนแบน -> เริ่มระบบ ***
                    initSystem();
                }
            })
            .catch((error) => {
                console.error("Error checking ban:", error);
                initSystem(); // ถ้า Error ให้เข้าได้ไปก่อน
            });
        }

        function initSystem() {
            const storedUser = localStorage.getItem('agentName');
            setTimeout(() => {
                if (storedUser) {
                    window.location.href = 'menu.html';
                } else {
                    document.getElementById('state-loading').classList.add('d-none');
                    document.getElementById('state-login').classList.remove('d-none');
                }
            }, 800);
        }

        // --- (โค้ด Register / Login เดิมด้านล่างนี้) ---
        function handleRegister() {
            const name = document.getElementById('regName').value.trim();
            const pin = document.getElementById('regPin').value.trim();
            const pinConfirm = document.getElementById('regPinConfirm').value.trim();
            const userIP = document.getElementById('user-ip').innerText;

            if (!name || pin.length !== 4) { alert("กรุณากรอกข้อมูลให้ครบ"); return; }
            if (pin !== pinConfirm) { alert("PIN ไม่ตรงกัน"); return; }

            db.collection("users").where("name", "==", name).get().then((q) => {
                if (!q.empty) { alert("ชื่อซ้ำ"); } 
                else {
                    db.collection("users").add({
                        name: name, pin: pin, ip_address: userIP,
                        created_at: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        alert("สำเร็จ");
                        new bootstrap.Tab('#pills-login-tab').show();
                        document.getElementById('loginName').value = name;
                    });
                }
            });
        }

        function handleLogin() {
            const name = document.getElementById('loginName').value.trim();
            const pin = document.getElementById('loginPin').value.trim();
            
            if (!name || !pin) { alert("กรอกข้อมูลให้ครบ"); return; }

            db.collection("users").where("name", "==", name).where("pin", "==", pin).get()
            .then((q) => {
                if (!q.empty) {
                    localStorage.setItem('agentName', name);
                    window.location.href = 'menu.html';
                } else {
                    alert("ข้อมูลไม่ถูกต้อง");
                }
            });
        }
        
        document.getElementById('loginPin').addEventListener("keypress", function(e) { if (e.key === "Enter") handleLogin(); });
    </script>
</body>
</html>
